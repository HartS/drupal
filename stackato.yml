name: drupal
framework: php
services:
    mysql-drupal: mysql
    fs-drupal: filesystem
min_version:
    server: 1.0
hooks:
    post-staging:
        # First we get drush and put it in the app root (more secure).
        - curl -sfS http://ftp.drupal.org/files/projects/drush-7.x-5.1.tar.gz | tar xzf -
        - mv drush "$STACKATO_APP_ROOT"/

        # Then we use drush to download drupal (and move it to our home directory)
        - $STACKATO_APP_ROOT/drush/drush dl drupal --drupal-project-rename=drupal --yes
        - mv drupal/* drupal/.??* .
        - rmdir drupal

        # This does the full install.
        - $STACKATO_APP_ROOT/drush/drush -r $HOME site-install -y --db-url=$DATABASE_URL --account-name=admin --account-pass=passwd --site-name=Stackato --locale=en-US

        # Download and enable a few sample modules
        - $STACKATO_APP_ROOT/drush/drush -r $HOME dl pathauto,views --yes
        - $STACKATO_APP_ROOT/drush/drush -r $HOME en pathauto,views_ui --yes

        #- mv profiles/modules/* sites/all/modules/
        
        # create sites in the shared filesystem and migrate
        - mkdir -p $STACKATO_FILESYSTEM/sites
        - mv sites/* $STACKATO_FILESYSTEM/sites/
        
        # rename old directories
        - mv sites sites_old
        
        # link to sites folder in the shared filesystem
        - ln -s "$STACKATO_FILESYSTEM"/sites sites

    pre-running:
        # remove some directories
        - chmod u+w sites
        - rm -rf sites
        
        # link to sites folder in the shared filesystem
        - ln -s "$STACKATO_FILESYSTEM"/sites sites
        - chmod u-w sites

        # Workaround to pass $VCAP_SERVICES to cron
        - echo $VCAP_SERVICES | tee $STACKATO_APP_ROOT/VCAP_SERVICES.json
cron:
    - "*/15 * * * * VCAP_SERVICES=$(cat $STACKATO_APP_ROOT/VCAP_SERVICES.json) $STACKATO_APP_ROOT/drush/drush cron >>$STACKATO_APP_ROOT/logs/cron.log 2>&1"
